(function(){Cowbell.Common.AYChip=function(d){var c=[0,369/196605,438/196605,521/196605,619/196605,735/196605,874/196605,1039/196605,1234/196605,1467/196605,1744/196605,2072/196605,2463/196605,2927/196605,3479/196605,4135/196605,4914/196605,5841/196605,6942/196605,8250/196605,9806/196605,11654/196605,13851/196605,16462/196605,19565/196605,23253/196605,27636/196605,32845/196605,39037/196605,46395/196605,55141/196605,65535/196605],r={ABC:[0.25,0.5,0.75],ACB:[0.25,0.75,0.5],BAC:[0.5,0.25,0.75],BCA:[0.75,
0.25,0.5],CAB:[0.5,0.75,0.25],CBA:[0.75,0.5,0.25]},h=d.frequency,e=d.sampleRate,s=d.mode,n=[0,0,0.004583,0.004583,0.006821,0.006821,0.009684,0.009684,0.014114,0.014114,0.020614,0.020614,0.028239,0.028239,0.045633,0.045633,0.056376,0.056376,0.08822,0.08822,0.117568,0.117568,0.149977,0.149977,0.190123,0.190123,0.229088,0.229088,0.282717,0.282717,0.333324,0.333324],f=h/e,g=2*(h/e),l=0,m=8,a=0,b=0,A=8,v=0,G=0,B=8,w=0,x=0,C=16,y=0,t=1,H=0,I=0,J=0,K=0,L=0,M=0,D=256,u=0,z=31,E=!0,N=0,F=0,O=0,P=0,Q=0,p=0;
d=d.panning?d.panning:d.stereoMode?r[d.stereoMode.toUpperCase()]||[0.5,0.5,0.5]:[0.5,0.5,0.5];"YM"==s&&(n=c);for(var q=[],c=0;3>c;c++)q[c]=[Math.sqrt(1-d[c]),Math.sqrt(d[c])];var k=new Uint8Array(14);this.setRegister=function(a,b){k[a]=b;switch(a){case 0:case 1:m=8*((k[1]&15)<<8|k[0]);0===m&&(m=8);break;case 2:case 3:A=8*((k[3]&15)<<8|k[2]);0===A&&(A=8);break;case 4:case 5:B=8*((k[5]&15)<<8|k[4]);0===B&&(B=8);break;case 6:C=16*(b&31);0===C&&(C=16);break;case 7:H=b&1?255:0;I=b&2?255:0;J=b&4?255:0;
K=b&8?255:0;L=b&16?255:0;M=b&32?255:0;break;case 11:case 12:D=16*(k[12]<<8|k[11]);0===D&&(D=16);break;case 13:u=0,z=32,E=!0,F=0,O=b&1?31:0,N=b&2?31:0,P=b&4?31:0,Q=b&8?31:0}};this.generate=function(e,c,d){d=c+d;var h=e.getChannelData(0);for(e=e.getChannelData(1);c<d;c++){for(a-=f;0>a;)a+=m,l^=255;for(v-=f;0>v;)v+=A,b^=255;for(w-=f;0>w;)w+=B,G^=255;for(y-=f;0>y;)y+=C,t+1&2&&(x^=255),t&1&&(t^=147456),t>>=1;for(u-=g;0>u;)u+=D,z--,0>z&&(z=31,E=!1,F^=31),p=z^(F&&N),E||(p|=O),p^=P,E||(p&=Q);var s=n[(k[8]&
16?p:(k[8]&15)<<1)&(l|H)&(x|K)],r=n[(k[9]&16?p:(k[9]&15)<<1)&(b|I)&(x|L)],R=n[(k[10]&16?p:(k[10]&15)<<1)&(G|J)&(x|M)];h[c]=q[0][0]*s+q[1][0]*r+q[2][0]*R;e[c]=q[0][1]*s+q[1][1]*r+q[2][1]*R}}};Cowbell.Common.AYGenerator=function(d,c,r){var h,e,s=this,n,f,g=0,l=0;this.seekable=!0;this.seek=function(m){m*=c.sampleRate;l=Math.floor(m/e);var a=n[l];if(a)for(var b=0;14>b;b++)f.setRegister(b,a[b]);g=e-m%e;l++};this.reset=function(){this.seek(0)};this.generateAudio=function(c){for(var a=0;a<c.length;){var b=
c.length-a;if(b<e){f.generate(c,a,b);a+=b;g-=b;break}else b=Math.floor(g),f.generate(c,a,b),a+=b,g-=b;if(l>=n.length)break;for(var b=n[l],d=0;13>d;d++)f.setRegister(d,b[d]);b[14]&&f.setRegister(13,b[13]);l++;g+=e}return a};this.load=function(g){this.channelCount=2;var a=new XMLHttpRequest;a.addEventListener("error",function(a){console.log("XHR error",a)});a.addEventListener("load",function(b){data=a.response;b=new Uint8Array(data);r(b,function(a){n=a.ayRegisterLog;f=new Cowbell.Common.AYChip({frequency:a.ayFrequency||
1773400,panning:a.panning,stereoMode:a.stereoMode,sampleRate:c.sampleRate,mode:a.ayMode||"AY"});h=1/(a.commandFrequency||50);e=h*c.sampleRate;s.duration=n.length*h;g()})});a.open("GET",d,!0);a.responseType="arraybuffer";a.send()}}})();(function(){function d(c,d,h,e){h||(h={});e||(e={});return new Cowbell.Common.AYGenerator(c,d,function(c,d){if("PSG\u001a"!==String.fromCharCode.apply(null,c.subarray(0,4)))throw"Not a PSG file";for(var f=16,g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,!1],l=[],m;f<c.length;){for(g[14]=!1;;){var a=c[f];f++;if(253==a){f=c.length;break}else if(255==a){m=1;break}else if(254==a){m=4*c[f];f++;break}else if(14>a)g[a]=c[f],f++,13==a&&(g[14]=!0);else throw"Unexpected command: "+a;}for(a=0;a<m;a++)l.push(g.slice())}d({ayRegisterLog:l,
ayFrequency:e.ayFrequency||h.ayFrequency,commandFrequency:e.commandFrequency||h.commandFrequency,stereoMode:e.stereoMode||h.stereoMode,panning:e.panning||h.panning,ayMode:e.ayMode||h.ayMode})})}Cowbell.Player.PSG=function(c){return new Cowbell.Common.WebAudioPlayer(d,c)}})();
