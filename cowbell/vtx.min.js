(function(){var g=function(a){this.buffer=a;this.offset=0;this.subOffset=7};g.SeekAbsolute=0;g.SeekRelative=1;g.prototype.readBits=function(a){for(var d=[1,2,4,8,16,32,64,128],c=this.buffer[this.offset],e=0,f=0;f<a;f++){var b=(c&d[this.subOffset])>>this.subOffset,e=e<<1,e=e|b;this.subOffset--;if(0>this.subOffset){if(this.offset+1>=this.buffer.length)return-1;c=this.buffer[++this.offset];this.subOffset=7}}return e};g.prototype.readUInt8=function(){return this.offset+1>=this.buffer.length?-1:this.buffer[this.offset++]};
g.prototype.readUInt16=function(){if(this.offset+2>=this.buffer.length)return-1;var a=this.buffer[this.offset]&255|this.buffer[this.offset+1]<<8&65280;this.offset+=2;return a};g.prototype.readUInt32=function(){if(this.offset+4>=this.buffer.length)return-1;var a=this.buffer[this.offset]&255|this.buffer[this.offset+1]<<8&65280|this.buffer[this.offset+2]<<16&16711680|this.buffer[this.offset+3]<<24&4278190080;this.offset+=4;return a};g.prototype.readString=function(a){if(this.offset+a>=this.buffer.length)return-1;
for(var d="",c=0;c<a;c++)d+=String.fromCharCode(this.buffer[this.offset++]);return d};g.prototype.readLength=function(){var a=this.readBits(3);if(-1==a)return-1;if(7==a)for(;0!=this.readBits(1);)a++;return a};g.prototype.seek=function(a,d){switch(d){case g.SeekAbsolute:this.offset=a;this.subOffset=7;break;case g.SeekRelative:this.offset+=a,this.subOffset=7}};g.prototype.getPosition=function(){return this.offset};var q=function(a){this.offset=0;this.size=a;this.data=new Uint8Array(a)};q.prototype.write=
function(a){this.data[this.offset++]=a};var h=function(){};h.LEAF=32768;h.prototype.setConstant=function(a){this.tree[0]=a|h.LEAF};h.prototype.expand=function(){for(var a=this.allocated;this.nextEntry<a;)this.tree[this.nextEntry]=this.allocated,this.allocated+=2,this.nextEntry++};h.prototype.addCodesWithLength=function(a,d){for(var c=!0,e=0;e<a.length;e++)if(a[e]==d){var f=this.nextEntry++;this.tree[f]=e|h.LEAF}else a[e]>d&&(c=!1);return c};h.prototype.build=function(a,d){this.tree=[];for(var c=0;c<
d;c++)this.tree[c]=h.LEAF;this.nextEntry=0;this.allocated=1;c=0;do this.expand(),c++;while(!this.addCodesWithLength(a,c))};h.prototype.readCode=function(a){for(var d=this.tree[0];0==(d&h.LEAF);)var c=a.readBits(1),d=this.tree[d+c];return d&~h.LEAF};var b=function(a){this.data=[];this.size=a;this.offset=0};b.prototype.add=function(a){this.data[this.offset]=a;this.offset=(this.offset+1)%this.size};b.prototype.get=function(a,d){for(var c=this.offset+this.size-a-1,e=[],f=0;f<d;f++){var b=this.data[(c+
f)%this.size];e.push(b);this.add(b)}return e};var m=function(a,d){this.reader=a;this.offsetTree=new h;this.codeTree=new h;if("lh4"==d)this.ringBuffer=new b(8192);else if("lh5"==d)this.ringBuffer=new b(16384);else throw"mode must be either lh4 or lh5";};m.prototype.readTempTable=function(){var a=this.reader,d=Math.min(a.readBits(5),19);if(0>=d)a=a.readBits(5),this.offsetTree.setConstant(a);else{for(var c=[],e=0;e<d;e++){var b=a.readLength();c.push(b);if(2==e)for(b=a.readBits(2);0<b--;)c.push(0),e++}this.offsetTree.build(c,
38)}};m.prototype.readCodeTable=function(){var a=this.reader,d=Math.min(a.readBits(9),510);if(0>=d)a=a.readBits(9),this.codeTree.setConstant(a);else{for(var c=[],b=0;b<d;){var f=this.offsetTree.readCode(a);if(2>=f){var k=1;for(1==f?k=a.readBits(4)+3:2==f&&(k=a.readBits(9)+20);0<=--k;)c.push(0),b++}else c.push(f-2),b++}this.codeTree.build(c,1020)}};m.prototype.readOffsetTable=function(){var a=this.reader,d=Math.min(a.readBits(4),14);if(0>=d)a=a.readBits(4),this.offsetTree.setConstant(a);else{for(var b=
[],e=0;e<d;e++){var f=a.readLength();b[e]=f}this.offsetTree.build(b,38)}};m.prototype.extract=function(a,b,c,e){function f(){h.extractBlock(k)&&(c&&c(k.offset,k.size),k.offset>=k.size||setTimeout(f,1))}this.reader.seek(a,g.SeekAbsolute);var k=new q(b),h=this;setTimeout(f,1);return k.data};m.prototype.extractBlock=function(a){var b=this.reader,c=b.readBits(16);if(0>=c||b.offset>=b.size)return!1;this.readTempTable();this.readCodeTable();this.readOffsetTable();for(var e=0;e<c;e++){var f=this.codeTree.readCode(b);
if(256>f)this.ringBuffer.add(f),a.write(f);else{var k=this.offsetTree.readCode(b),h=k;2<=k&&(h=b.readBits(k-1),h+=1<<k-1);var f=this.ringBuffer.get(h,f-256+3),g;for(g in f)a.write(f[g])}}return!0};Cowbell.Common.LhaArrayReader=g;Cowbell.Common.LhaReader=m})();(function(){function g(g,h){return new Cowbell.Common.AYGenerator(g,h,function(b,h){var a=String.fromCharCode.apply(null,b.subarray(0,2));if("ay"!==a&&"ym"!==a)throw"Not a VTX file";for(var d=a.toUpperCase(),c={1:"abc",2:"acb",3:"bac",4:"bca",5:"cab",6:"cba"}[b[2]&7]||"mono",e=b[8]<<24|b[7]<<16|b[6]<<8|b[5],f=b[9],g=b[15]<<24|b[14]<<16|b[13]<<8|b[12],a=16;0!==b[a];)a++;String.fromCharCode.apply(null,b.subarray(16,a));a++;for(var l=a;0!==b[a];)a++;String.fromCharCode.apply(null,b.subarray(l,a));a++;
for(l=a;0!==b[a];)a++;String.fromCharCode.apply(null,b.subarray(l,a));a++;for(l=a;0!==b[a];)a++;String.fromCharCode.apply(null,b.subarray(l,a));a++;for(l=a;0!==b[a];)a++;String.fromCharCode.apply(null,b.subarray(l,a));a++;var q=(new Cowbell.Common.LhaReader(new Cowbell.Common.LhaArrayReader(b),"lh5")).extract(a,g,function(a,b){if(!(a<b)){for(var l=g/14,t=[],u=0,r=0;r<l;r++){for(var n=[],p=0;14>p;p++){var s=q[p*l+r];13>p?n[p]=s:255==s?(n[13]=u,n[14]=!1):(u=n[13]=s,n[14]=!0)}t[r]=n}h({ayRegisterLog:t,
ayFrequency:e,commandFrequency:f,stereoMode:c,ayMode:d})}})})}Cowbell.Player.VTX=function(){return new Cowbell.Common.WebAudioPlayer(g)}})();
