(function(){function n(p,r,g,a){function n(m){if(!g.pathToLibPSGPlay)throw"pathToLibPSGPlay not specified";if(window.libpsgplay&&window.libpsgplay._psgplay_init)m();else{var a=document.getElementsByTagName("head")[0],d=document.createElement("script");d.src=g.pathToLibPSGPlay;window.libpsgplay={onRuntimeInitialized:function(){m();a.removeChild(d)}};a.appendChild(d)}}var l,h,q=this,e;g||(g={});a||(a={});this.cleanup=function(){l&&libpsgplay._psgplay_free(l);h&&libpsgplay._free(h);e&&libpsgplay._free(e)};
this.load=function(m){var g=this;n(function(){g.channelCount=2;var d=new XMLHttpRequest;d.addEventListener("error",function(b){console.log("XHR error",b)});d.addEventListener("load",function(b){data=d.response;a:{b=new Int8Array(data);h=libpsgplay._malloc(16384);e=q.duration=0;var c=libpsgplay._malloc(4);if(Module.ccall("ice_identify","number",["array","number"],[b,b.byteLength])){var f=Module.ccall("ice_decrunched_size","number",["array","number"],[b,b.byteLength]);e=libpsgplay._malloc(f);if(-1==
Module.ccall("ice_decrunch","number",["number","array","number"],[e,b,b.byteLength])){console.log("ICE decrunch failed\n");break a}a.track||(libpsgplay._sndh_tag_default_subtune(c,e,f)?a.track=libpsgplay.HEAP32[c/4]:a.track=1);libpsgplay._sndh_tag_subtune_time(c,a.track,e,f)&&(q.duration=libpsgplay.HEAPF32.subarray(c/4,c/4+1)[0]);l=libpsgplay._psgplay_init(e,f,a.track,r.sampleRate)}else a.track||(Module.ccall("sndh_tag_default_subtune","boolean",["number","array","number"],[c,b,b.byteLength])?a.track=
libpsgplay.HEAP32[c/4]:a.track=1),Module.ccall("sndh_tag_subtune_time","boolean",["number","number","array","number"],[c,a.track,b,b.byteLength])&&(q.duration=libpsgplay.HEAPF32.subarray(c/4,c/4+1)[0]),l=Module.ccall("psgplay_init","number",["array","number","number","number"],[b,b.byteLength,a.track,r.sampleRate]);c&&libpsgplay._free(c)}m()});d.open("GET",p,!0);d.responseType="arraybuffer";d.send()})};this.generateAudio=function(a){var e=a.getChannelData(0),d=a.getChannelData(1);a=a.length;for(var b=
0;0<a;){for(var c=Math.min(a,4096),f=Module.ccall("psgplay_read_stereo","number",["number","number","number"],[l,h,c]),g=libpsgplay.HEAP16.subarray(h/2,h/2+2*f),k=0;k<f;++k)e[b+k]=g[2*k]/32768,d[b+k]=g[2*k+1]/32768;a-=f;b+=f;if(f<c)break}return b};this.seekable=!0;this.seek=function(a){};this.reset=function(){this.seek(0)}}Cowbell.Player.PSGPlay=function(p){return new Cowbell.Common.WebAudioPlayer(n,p)}})();
